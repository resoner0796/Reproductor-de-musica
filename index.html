<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Reproductor de Música Definitivo</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1b26" />
    <link rel="apple-touch-icon" href="images/icons/icon-192x192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>

    <style>
        /* TEMA: Medianoche (Default) */
        :root { 
            --bg-primary: #1a1b26; --bg-secondary: #24283b; --bg-tertiary: #414868;
            --bg-interactive: #565f89; --text-primary: #c0caf5; --text-secondary: #a9b1d6;
            --accent-primary: #bb9af7; --accent-hover: #dbb2ff;
            --bg-glass: rgba(36, 40, 59, 0.65); --border-glass: rgba(192, 202, 245, 0.15);
        }
        /* TEMA: Ámbar */
        .theme-sunset {
            --bg-primary: #2d1d2b; --bg-secondary: #452a42; --bg-tertiary: #6d435a;
            --bg-interactive: #9d6b7b; --text-primary: #f5e0e6; --text-secondary: #e6c0c8;
            --accent-primary: #ff7a5c; --accent-hover: #ff9e86;
            --bg-glass: rgba(69, 42, 66, 0.65); --border-glass: rgba(245, 224, 230, 0.15);
        }
        /* TEMA: Bosque */
        .theme-ocean {
            --bg-primary: #1f2c27; --bg-secondary: #2a3b34; --bg-tertiary: #4a5c53;
            --bg-interactive: #6b8072; --text-primary: #d4e5d8; --text-secondary: #b8ccbe;
            --accent-primary: #79dcaa; --accent-hover: #93ffc7;
            --bg-glass: rgba(42, 59, 52, 0.65); --border-glass: rgba(212, 229, 216, 0.15);
        }

        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-primary); color: var(--text-secondary); transition: background-color 0.3s; }
        
        .main-container { display: flex; flex-direction: column; height: 100%; width: 100%; max-width: 450px; margin: auto; background-color: var(--bg-primary); box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        main { flex-grow: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; position: relative; }

        .glass-effect {
            background-color: var(--bg-glass);
            -webkit-backdrop-filter: blur(14px);
            backdrop-filter: blur(14px);
            border: 1px solid var(--border-glass);
        }
        .player-view-content, .controls-container, #mini-player-bar { background-color: transparent; }
        .player-view-content > div, .controls-container-inner, .mini-player-inner { border-radius: 0.75rem; }
        .tab-bar { 
            background-color: var(--bg-glass);
            -webkit-backdrop-filter: blur(14px);
            backdrop-filter: blur(14px);
            border-top: 1px solid var(--border-glass);
        }
        .context-menu, .modal-content, #now-playing-container {
            background-color: var(--bg-glass) !important;
            -webkit-backdrop-filter: blur(14px) !important;
            backdrop-filter: blur(14px) !important;
            border: 1px solid var(--border-glass) !important;
        }

        h1, h2, h3, .text-primary { color: var(--text-primary); }
        .play-pause-btn, .action-btn { background-color: var(--accent-primary); color: var(--bg-primary); }
        .play-pause-btn:hover, .action-btn:hover { background-color: var(--accent-hover); }
        .accent-text, .tab.active, .control-btn.active { color: var(--accent-primary); }
        .tab.active { border-bottom-color: var(--accent-primary); }
        .tab.active svg { stroke: var(--accent-primary); }
        .hover-bg:hover { background-color: var(--bg-tertiary); }
        .list-item:hover, details[open] > summary { background-color: var(--bg-interactive); }
        .list-item.playing { background-color: var(--bg-interactive); color: var(--accent-primary); border-left: 3px solid var(--accent-primary); padding-left: calc(0.75rem - 3px); }
        
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: var(--bg-tertiary); border-radius: 5px; outline: none; cursor: pointer; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: var(--text-primary); border-radius: 50%; }
        
        .modal-backdrop { transition: opacity 0.3s ease-in-out; background-color: rgba(0,0,0,0.7); }
        .form-input { color: var(--text-primary); background-color: var(--bg-secondary); border: 1px solid var(--bg-tertiary); }
        
        .view { display: none; height: 100%; }
        .view.active { display: flex; flex-direction: column; }
        #library-view.active, #playlists-view.active, #download-view.active { display: block; }
        
        main::-webkit-scrollbar { width: 8px; }
        main::-webkit-scrollbar-track { background: var(--bg-secondary); }
        main::-webkit-scrollbar-thumb { background-color: var(--bg-interactive); border-radius: 10px; border: 2px solid var(--bg-secondary); }
        
        #bottom-bar-wrapper { flex-shrink: 0; position: relative; }
        #mini-player-bar {
            transition: transform 0.3s ease-in-out;
            transform: translateY(100%);
            position: absolute;
            bottom: 60px; /* Altura aproximada del tab-bar */
            left: 0.5rem; right: 0.5rem;
            border-radius: 0.5rem;
        }
        #mini-player-bar.visible { transform: translateY(0); }

        .toast-notification {
            position: fixed;
            bottom: 80px; left: 50%;
            transform: translate(-50%, 20px);
            padding: 0.75rem 1.25rem; border-radius: 9999px;
            background-color: var(--accent-primary); color: var(--bg-primary);
            font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000; opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        #now-playing-container {
            position: absolute;
            top: 60px; /* Debajo de la barra superior */
            right: 1rem;
            width: 80%;
            max-width: 320px;
            max-height: 50%;
            border-radius: 0.75rem;
            z-index: 45; /* Encima de todo menos modales */
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
        }
        #now-playing-container.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        #now-playing-list { overflow-y: auto; }
        #now-playing-list .list-item { padding-left: 0.75rem; padding-right: 0.75rem; }
        #now-playing-backdrop { position: fixed; inset: 0; z-index: 44; }
        
        #library-view details summary {
            padding: 0.75rem 0.5rem;
            cursor: pointer;
            outline: none;
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            transition: background-color 0.2s;
            border-radius: 0.5rem;
        }
        #library-view details > div {
            padding-left: 1rem;
        }
        #library-view details .sub-list-item {
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
        }
        #library-view details .sub-list-item:hover {
            background-color: var(--bg-tertiary);
        }
    </style>
</head>
<body>
    
    <div class="main-container">
        <main class="p-4 pb-0">
            <div id="now-playing-backdrop" class="hidden"></div>
            
            <div id="player-view" class="view active justify-between h-full space-y-4">
                 <div class="flex-shrink-0 flex justify-between items-center">
                    <div class="w-10 h-10"></div> <h3 class="text-lg font-semibold text-primary">Reproduciendo</h3>
                    <div class="flex items-center space-x-2 z-10">
                        <button id="settings-btn" class="p-2 hover-bg rounded-full"></button>
                    </div>
                </div>

                <div class="player-view-content flex-grow flex flex-col justify-center items-center space-y-4 p-4">
                    <div class="relative aspect-square w-full max-w-xs rounded-xl shadow-lg overflow-hidden glass-effect">
                        <img id="album-art" src="https://placehold.co/400x400/1a1b26/1a1b26" alt="Carátula" class="w-full h-full object-cover">
                    </div>
                    <div class="text-center w-full px-4">
                        <h2 id="song-title" class="text-2xl font-bold truncate">Bienvenido</h2>
                        <p id="song-artist" class="text-md truncate">Carga tu música en la Biblioteca</p>
                    </div>
                </div>
                
                <div class="controls-container flex-shrink-0 space-y-4 p-4">
                        <div class="controls-container-inner space-y-4 p-4 glass-effect">
                            <div class="space-y-2">
                                <input type="range" id="progress-bar" value="0" class="w-full">
                                <div class="flex justify-between text-xs font-mono"><span id="current-time">0:00</span><span id="duration">0:00</span></div>
                            </div>
                            <div class="flex items-center justify-around">
                                <button id="shuffle-btn" class="p-2 control-btn"></button>
                                <button id="prev-btn" class="p-2"></button>
                                <button id="play-pause-btn" class="play-pause-btn w-16 h-16 flex items-center justify-center rounded-full shadow-lg"></button>
                                <button id="next-btn" class="p-2"></button>
                                <div class="flex items-center">
                                    <button id="repeat-btn" class="p-2 control-btn"></button>
                                    <button id="now-playing-toggle-btn" class="p-2 hover-bg rounded-full"></button>
                                </div>
                            </div>
                            <div class="flex items-center justify-center space-x-2">
                                <svg width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M3 9v6h4l5 5V4L7 9H3z"></path></svg>
                                <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1" class="w-1/2">
                                <svg width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77zM16.5 12c0-1.77-1-3.29-2.5-4.03v8.05c1.5-0.73 2.5-2.25 2.5-4.02zM3 9v6h4l5 5V4L7 9H3z"></path></svg>
                            </div>
                        </div>
                </div>
            </div>

            <div id="now-playing-container">
                <h3 class="text-md font-semibold text-primary p-3 pb-2 flex-shrink-0">A continuación</h3>
                <ul id="now-playing-list" class="space-y-1 p-2"></ul>
            </div>

            <div id="library-view" class="view">
                <div class="flex justify-between items-center mb-4 sticky top-0 bg-primary pt-2 pb-2 z-10">
                    <h1 class="text-2xl font-bold">Mi Biblioteca</h1>
                    <button id="add-files-btn" class="action-btn px-4 py-2 rounded-lg text-sm font-bold">Añadir</button>
                </div>
                <div id="library-content" class="space-y-4 pb-40"></div>
            </div>

            <div id="playlists-view" class="view"></div>
            
            <div id="download-view" class="view p-4">
                <div class="flex justify-between items-center mb-6 sticky top-0 bg-primary pt-2 pb-2 z-10">
                    <h1 class="text-2xl font-bold">Descargar desde Link</h1>
                </div>
                <div class="space-y-4">
                    <p class="text-sm text-text-secondary">Pega un enlace de YouTube para convertirlo a MP3 y añadirlo a tu biblioteca.</p>
                    <div>
                        <textarea id="youtube-link-input" class="form-input w-full p-3 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-accent-primary" rows="3" placeholder="https://www.youtube.com/watch?v=..."></textarea>
                    </div>
                    <button id="convert-btn" class="action-btn w-full py-3 rounded-lg font-bold">Convertir y Descargar</button>
                </div>
            </div>
        </main>

        <div id="bottom-bar-wrapper">
             <div id="mini-player-bar" class="px-2 glass-effect cursor-pointer">
                    <div class="mini-player-inner p-2 flex items-center space-x-3">
                        <img id="mini-album-art" src="https://placehold.co/96x96/1a1b26/1a1b26" alt="Mini Carátula" class="w-12 h-12 rounded-md flex-shrink-0 object-cover">
                        <div class="flex-grow truncate">
                            <p id="mini-song-title" class="font-semibold text-primary truncate">Sin música</p>
                            <p id="mini-song-artist" class="text-sm truncate">Selecciona una canción</p>
                        </div>
                        <button id="mini-play-pause-btn" class="play-pause-btn w-12 h-12 flex items-center justify-center rounded-full shadow-lg flex-shrink-0"></button>
                    </div>
            </div>
            <nav class="tab-bar flex justify-around p-2">
                <button class="tab active flex flex-col items-center text-xs w-full py-1 border-b-2" data-view="player-view"></button>
                <button class="tab flex flex-col items-center text-xs w-full py-1 border-b-2 border-transparent" data-view="library-view"></button>
                <button class="tab flex flex-col items-center text-xs w-full py-1 border-b-2 border-transparent" data-view="playlists-view"></button>
                <button class="tab flex flex-col items-center text-xs w-full py-1 border-b-2 border-transparent" data-view="download-view"></button>
            </nav>
        </div>
    </div>

    <div id="context-menu-backdrop" class="context-menu-backdrop fixed inset-0 z-40 hidden"></div>
    <div id="context-menu" class="context-menu fixed z-50 hidden rounded-lg shadow-xl p-2 text-sm w-48 text-primary"></div>
    <div id="modal-container" class="fixed inset-0 z-50 hidden items-center justify-center p-4"></div>
    
    <template id="song-item-template">
        <li class="list-item flex items-center p-2 rounded-lg cursor-pointer space-x-3 transition-colors">
            <img class="w-12 h-12 rounded-md object-cover flex-shrink-0 bg-tertiary" data-art-src>
            <div class="flex-grow truncate">
                <p class="font-semibold text-primary truncate" data-title></p>
                <p class="text-sm truncate" data-artist></p>
            </div>
            <button class="options-btn p-2 rounded-full hover-bg flex-shrink-0">
                <svg width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M12 16a2 2 0 0 1 2 2a2 2 0 0 1-2 2a2 2 0 0 1-2-2a2 2 0 0 1 2-2m0-6a2 2 0 0 1 2 2a2 2 0 0 1-2 2a2 2 0 0 1-2-2a2 2 0 0 1 2-2m0-6a2 2 0 0 1 2 2a2 2 0 0 1-2 2a2 2 0 0 1-2-2a2 2 0 0 1 2-2z"/></svg>
            </button>
        </li>
    </template>
    
    <input type="file" id="file-input" accept=".mp3" multiple class="hidden">
    <audio id="audio1" crossorigin="anonymous" playsinline webkit-playsinline></audio>
    <audio id="audio2" crossorigin="anonymous" playsinline webkit-playsinline></audio>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const dom = {
            body: document.body, views: document.querySelectorAll('.view'), tabs: document.querySelectorAll('.tab'),
            albumArt: document.getElementById('album-art'), songTitle: document.getElementById('song-title'),
            songArtist: document.getElementById('song-artist'), progressBar: document.getElementById('progress-bar'),
            currentTime: document.getElementById('current-time'), duration: document.getElementById('duration'),
            playPauseBtn: document.getElementById('play-pause-btn'), nextBtn: document.getElementById('next-btn'),
            prevBtn: document.getElementById('prev-btn'), shuffleBtn: document.getElementById('shuffle-btn'),
            repeatBtn: document.getElementById('repeat-btn'), volumeSlider: document.getElementById('volume-slider'),
            miniPlayerBar: document.getElementById('mini-player-bar'), miniAlbumArt: document.getElementById('mini-album-art'),
            miniSongTitle: document.getElementById('mini-song-title'), miniSongArtist: document.getElementById('mini-song-artist'),
            miniPlayPauseBtn: document.getElementById('mini-play-pause-btn'),
            settingsBtn: document.getElementById('settings-btn'),
            addFilesBtn: document.getElementById('add-files-btn'),
            libraryContent: document.getElementById('library-content'),
            playlistsView: document.getElementById('playlists-view'),
            fileInput: document.getElementById('file-input'),
            contextMenu: document.getElementById('context-menu'), contextMenuBackdrop: document.getElementById('context-menu-backdrop'),
            modalContainer: document.getElementById('modal-container'), songItemTemplate: document.getElementById('song-item-template'),
            convertBtn: document.getElementById('convert-btn'),
            youtubeLinkInput: document.getElementById('youtube-link-input'),
            nowPlayingToggleBtn: document.getElementById('now-playing-toggle-btn'),
            nowPlayingContainer: document.getElementById('now-playing-container'),
            nowPlayingList: document.getElementById('now-playing-list'),
            nowPlayingBackdrop: document.getElementById('now-playing-backdrop'),
        };

        let audio1 = document.getElementById('audio1'); 
        let audio2 = document.getElementById('audio2');
        let state = {
            library: [], playlists: [], queue: [], currentContext: { type: 'library', id: null }, contextQueue: [],
            contextIndex: -1, currentSongId: null, isPlaying: false, isShuffle: false, repeatMode: 'none', volume: 1,
            settings: { theme: 'default', crossfadeEnabled: true, crossfadeDuration: 4 }
        };
        
        let db; 
        let currentAudio = audio1;
        let standbyAudio = audio2;
        let isCrossfading = false;
        
        function initDB(onSuccess) {
            const request = indexedDB.open('MusicPlayerDB', 2);
            request.onupgradeneeded = (event) => {
                const dbInstance = event.target.result;
                if (!dbInstance.objectStoreNames.contains('songs')) {
                    dbInstance.createObjectStore('songs', { keyPath: 'id' });
                }
            };
            request.onsuccess = (event) => {
                db = event.target.result;
                onSuccess();
            };
            request.onerror = (event) => console.error('Error con IndexedDB:', event.target.errorCode);
        }

        function saveSongToDB(song) {
            if (!db) return;
            const transaction = db.transaction(['songs'], 'readwrite');
            const { url, ...songToSave } = song; 
            transaction.objectStore('songs').put(songToSave);
        }

        function loadSongsFromDB(onLoad) {
            if (!db) return;
            const request = db.transaction(['songs'], 'readonly').objectStore('songs').getAll();
            request.onsuccess = () => {
                const songs = request.result.map(song => {
                    const blob = base64ToBlob(song.data, 'audio/mpeg');
                    return {
                        ...song,
                        url: URL.createObjectURL(blob)
                    };
                });
                onLoad(songs);
            };
        }
        
        function base64ToBlob(base64, contentType = '', sliceSize = 512) {
            const byteCharacters = atob(base64);
            const byteArrays = [];
            for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                const slice = byteCharacters.slice(offset, offset + sliceSize);
                const byteNumbers = new Array(slice.length);
                for (let i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                byteArrays.push(byteArray);
            }
            return new Blob(byteArrays, { type: contentType });
        }
        
        const audioManager = (() => {
            function play(song, startTime = 0) {
                if (!song) return; 

                audio1.pause();
                audio2.pause();

                currentAudio.src = song.url; 
                currentAudio.currentTime = startTime; 
                currentAudio.volume = state.volume;
                currentAudio.play().then(() => { 
                    state.isPlaying = true; 
                    updateUIonPlayPause(); 
                }).catch(e => console.error("Error al reproducir:", e));
            }
            function pause() { 
                currentAudio.pause(); 
                state.isPlaying = false; 
                updateUIonPlayPause(); 
            }
            function resume() { 
                currentAudio.play().then(() => { 
                    state.isPlaying = true; 
                    updateUIonPlayPause(); 
                }).catch(e => console.error("Error al reanudar:", e)); 
            }
            
            [audio1, audio2].forEach(audio => {
                audio.addEventListener('timeupdate', () => { 
                    if (audio === currentAudio) {
                        updateProgressUI(audio.currentTime, audio.duration); 
                        if (state.settings.crossfadeEnabled && !isCrossfading && audio.duration > 0 && (audio.duration - audio.currentTime) <= state.settings.crossfadeDuration) {
                            playNextSong(true);
                        }
                    }
                });
                audio.addEventListener('ended', () => { 
                    if (audio === currentAudio && !isCrossfading) handleTrackEnd(); 
                });
            });
            
            return { 
                play, pause, resume, 
                seek: (time) => { if (!isCrossfading) currentAudio.currentTime = time; },
                setVolume: (vol) => { 
                    currentAudio.volume = vol; 
                    standbyAudio.volume = vol;
                } 
            };
        })();
        
        function getSongById(id) { return state.library.find(song => song.id === id); }
        
        function getNextSongInContext() {
            if (state.isShuffle) {
                if (state.contextQueue.length <= 1) return (state.repeatMode !== 'none') ? getSongById(state.currentSongId) : null;
                let randomIndex;
                do { randomIndex = Math.floor(Math.random() * state.contextQueue.length); } while (state.contextQueue.length > 1 && state.contextQueue[randomIndex] === state.currentSongId);
                state.contextIndex = randomIndex; return getSongById(state.contextQueue[randomIndex]);
            } else {
                let nextIndex = state.contextIndex + 1;
                if (state.repeatMode === 'all' && nextIndex >= state.contextQueue.length) nextIndex = 0;
                if (nextIndex >= state.contextQueue.length && state.repeatMode !== 'all') return null;
                state.contextIndex = nextIndex; return getSongById(state.contextQueue[nextIndex]);
            }
        }
        
        function fadeVolume(audio, to, duration, onComplete) {
            const from = audio.volume;
            const steps = 50;
            const stepDuration = (duration * 1000) / steps;
            const delta = (to - from) / steps;
            let currentStep = 0;
            const timer = setInterval(() => {
                audio.volume = Math.max(0, Math.min(1, audio.volume + delta));
                if (++currentStep >= steps) {
                    clearInterval(timer);
                    audio.volume = to;
                    if (onComplete) onComplete();
                }
            }, stepDuration);
        }
        
        function crossfadeToSong(nextSong) {
            if (!nextSong || isCrossfading) return;
            isCrossfading = true;

            standbyAudio.src = nextSong.url;
            standbyAudio.volume = 0;
            standbyAudio.play().catch(e => console.error("Error al iniciar crossfade:", e));

            const duration = state.settings.crossfadeDuration;
            fadeVolume(currentAudio, 0, duration, () => {
                currentAudio.pause();
                if (currentAudio.src.startsWith('blob:')) {
                    URL.revokeObjectURL(currentAudio.src);
                }
            });
            fadeVolume(standbyAudio, state.volume, duration);

            setTimeout(() => {
                let temp = currentAudio;
                currentAudio = standbyAudio;
                standbyAudio = temp;
                
                state.currentSongId = nextSong.id;
                updatePlayerUI(nextSong);
                updateMediaSession(nextSong);
                updatePlayingStatusInLists();
                renderNowPlayingList();
                saveState();
                
                isCrossfading = false;
            }, duration * 1000);
        }

        function playNextSong(isAuto = false) {
             if (isCrossfading) return;
            if (state.repeatMode === 'one' && isAuto) {
                audioManager.play(getSongById(state.currentSongId), 0);
                return;
            }

            let nextSongToPlay = getSongById(state.queue.shift()) || getNextSongInContext();
            
            if (!nextSongToPlay) {
                if (!isAuto) {
                    state.isPlaying = false;
                    updateUIonPlayPause();
                }
                return;
            }

            if (isAuto && state.settings.crossfadeEnabled) {
                crossfadeToSong(nextSongToPlay);
            } else {
                state.currentSongId = nextSongToPlay.id;
                audioManager.play(nextSongToPlay);
                updatePlayerUI(nextSongToPlay);
                updateMediaSession(nextSongToPlay);
                updatePlayingStatusInLists();
                renderNowPlayingList();
                saveState();
            }
        }

        function playPrevSong() {
            if (isCrossfading) return;
            let prevIndex = (state.contextIndex > 0 && !state.isShuffle) ? state.contextIndex - 1 : 0;
            const prevSongId = state.contextQueue[prevIndex];
            if (prevSongId) {
                state.contextIndex = prevIndex; const song = getSongById(prevSongId);
                state.currentSongId = song.id; 
                audioManager.play(song);
                updatePlayerUI(song); 
                updateMediaSession(song); 
                updatePlayingStatusInLists(); 
                renderNowPlayingList();
                saveState();
            }
        }
        
        function handleTrackEnd() { if (state.isPlaying) playNextSong(true); }
        
        function initApp() {
            loadState(); 
            loadSongsFromDB((songsFromDB) => {
                state.library = songsFromDB;
                setupEventListeners();
                setupSVGs();
                applyTheme();
                renderAll();
                const lastSong = getSongById(state.currentSongId);
                updatePlayerUI(lastSong);
                updateControlButtonsUI();
                updateMiniPlayerVisibility();
                renderNowPlayingList();
            });
        }
        
        function saveState() {
            const stateToSave = {
                playlists: state.playlists, currentSongId: state.currentSongId, volume: state.volume, 
                settings: state.settings, isShuffle: state.isShuffle, repeatMode: state.repeatMode, queue: state.queue
            };
            localStorage.setItem('musicPlayerState', JSON.stringify(stateToSave));
        }

        function loadState() {
            const savedState = localStorage.getItem('musicPlayerState');
            if (savedState) {
                const parsed = JSON.parse(savedState);
                Object.assign(state, parsed);
                if (!state.queue) state.queue = [];
            }
        }

        function renderAll() { renderLibrary(); renderPlaylists(); updatePlayingStatusInLists(); }
        
        function createSongListItem(song) {
            const item = dom.songItemTemplate.content.cloneNode(true).querySelector('.list-item');
            item.dataset.songId = song.id;
            item.querySelector('[data-title]').textContent = song.title; 
            item.querySelector('[data-artist]').textContent = song.artist;
            item.querySelector('[data-art-src]').src = song.art || 'https://placehold.co/96x96/1a1b26/1a1b26';
            
            item.addEventListener('click', (e) => {
                if (e.target.closest('.options-btn')) return;

                const contextList = item.closest('ul');
                if (contextList && contextList.dataset.context === 'playlist') { 
                    playSongFromContext(song.id, 'playlist', contextList.dataset.playlistId); 
                } else { 
                    playSongFromContext(song.id, 'library'); 
                }
            });

            item.querySelector('.options-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                showContextMenu(e.clientX, e.clientY, [
                    { label: 'Añadir a la cola', action: () => { state.queue.push(song.id); showToast('Añadido a la cola'); renderNowPlayingList(); saveState(); } },
                    { label: 'Añadir a playlist...', action: () => openAddToPlaylistModal(song.id) },
                    { label: 'Editar', action: () => openEditSongModal(song.id) },
                ]);
            });
            return item;
        }

        function renderLibrary() {
            dom.libraryContent.innerHTML = '';
            if (state.library.length === 0) {
                dom.libraryContent.innerHTML = `<div class="text-center text-secondary p-8">Tu biblioteca está vacía.</div>`;
                return;
            }

            const artists = state.library.reduce((acc, song) => {
                (acc[song.artist] = acc[song.artist] || []).push(song);
                return acc;
            }, {});

            const albums = state.library.reduce((acc, song) => {
                if (song.album && song.album !== 'Desconocido') {
                    (acc[song.album] = acc[song.album] || []).push(song);
                }
                return acc;
            }, {});

            const createSection = (title, content) => {
                const details = document.createElement('details');
                const summary = document.createElement('summary');
                summary.textContent = title;
                details.appendChild(summary);
                details.appendChild(content);
                return details;
            };

            const songsContainer = document.createElement('div');
            const songsList = document.createElement('ul');
            songsList.className = 'space-y-1';
            state.library.forEach(song => songsList.appendChild(createSongListItem(song)));
            songsContainer.appendChild(songsList);
            dom.libraryContent.appendChild(createSection('Canciones', songsContainer));
            
            const artistsContainer = document.createElement('div');
            Object.keys(artists).sort().forEach(artistName => {
                const artistDetails = document.createElement('details');
                const artistSummary = document.createElement('summary');
                artistSummary.className = 'sub-list-item font-medium';
                artistSummary.textContent = artistName;
                const songsOfArtistList = document.createElement('ul');
                songsOfArtistList.className = 'space-y-1 pt-2 pl-4';
                artists[artistName].forEach(song => songsOfArtistList.appendChild(createSongListItem(song)));
                artistDetails.appendChild(artistSummary);
                artistDetails.appendChild(songsOfArtistList);
                artistsContainer.appendChild(artistDetails);
            });
            dom.libraryContent.appendChild(createSection('Artistas', artistsContainer));

            const albumsContainer = document.createElement('div');
             Object.keys(albums).sort().forEach(albumName => {
                const albumDetails = document.createElement('details');
                const albumSummary = document.createElement('summary');
                albumSummary.className = 'sub-list-item font-medium';
                albumSummary.textContent = albumName;
                const songsOfAlbumList = document.createElement('ul');
                songsOfAlbumList.className = 'space-y-1 pt-2 pl-4';
                albums[albumName].forEach(song => songsOfAlbumList.appendChild(createSongListItem(song)));
                albumDetails.appendChild(albumSummary);
                albumDetails.appendChild(songsOfAlbumList);
                albumsContainer.appendChild(albumDetails);
            });
            dom.libraryContent.appendChild(createSection('Álbumes', albumsContainer));
            
            updatePlayingStatusInLists();
            setContext('library');
        }


        function updatePlayingStatusInLists() { document.querySelectorAll('.list-item').forEach(item => item.classList.toggle('playing', item.dataset.songId === state.currentSongId)); }
        
        function updatePlayerUI(song) {
            const defaultArt = 'https://placehold.co/400x400/1a1b26/1a1b26';
            if (!song) {
                dom.songTitle.textContent = 'Bienvenido'; dom.songArtist.textContent = 'Carga tu música'; dom.albumArt.src = defaultArt;
                updateMiniPlayerVisibility(); return;
            }
            dom.songTitle.textContent = song.title; dom.songArtist.textContent = song.artist;
            dom.albumArt.src = song.art || defaultArt; dom.miniSongTitle.textContent = song.title;
            dom.miniSongArtist.textContent = song.artist; dom.miniAlbumArt.src = song.art || 'https://placehold.co/96x96/1a1b26/1a1b26';
            updateMiniPlayerVisibility();
        }

        function updateProgressUI(currentTime, duration) {
            if (isNaN(duration)) return;
            dom.progressBar.value = (currentTime / duration) * 100;
            dom.currentTime.textContent = formatTime(currentTime); dom.duration.textContent = formatTime(duration);
        }

        function updateUIonPlayPause() {
            [dom.playPauseBtn, dom.miniPlayPauseBtn].forEach(btn => {
                const playIcon = btn.querySelector('[data-play-icon]'); const pauseIcon = btn.querySelector('[data-pause-icon]');
                playIcon.classList.toggle('hidden', state.isPlaying); pauseIcon.classList.toggle('hidden', !state.isPlaying);
            });
        }

        function togglePlayPause() {
            if (state.isPlaying) audioManager.pause(); 
            else if (state.currentSongId) audioManager.resume();
            else if (state.library.length > 0) playSongFromContext(state.library[0].id, 'library');
        }

        function setupEventListeners() {
            dom.tabs.forEach(tab => tab.addEventListener('click', () => switchView(tab.dataset.view)));
            dom.playPauseBtn.addEventListener('click', togglePlayPause);
            dom.miniPlayPauseBtn.addEventListener('click', (e) => { e.stopPropagation(); togglePlayPause(); });
            dom.miniPlayerBar.addEventListener('click', () => switchView('player-view'));
            dom.nextBtn.addEventListener('click', () => playNextSong(false)); 
            dom.prevBtn.addEventListener('click', playPrevSong);
            dom.shuffleBtn.addEventListener('click', toggleShuffle); 
            dom.repeatBtn.addEventListener('click', cycleRepeatMode);
            dom.progressBar.addEventListener('input', (e) => audioManager.seek((e.target.value / 100) * (currentAudio.duration || 0)));
            dom.volumeSlider.addEventListener('input', (e) => { 
                state.volume = parseFloat(e.target.value); 
                audioManager.setVolume(state.volume); 
            });
            dom.volumeSlider.addEventListener('change', saveState);
            dom.addFilesBtn.addEventListener('click', () => dom.fileInput.click());
            dom.fileInput.addEventListener('change', handleFileSelect);
            dom.settingsBtn.addEventListener('click', openSettingsModal); 
            
            dom.contextMenuBackdrop.addEventListener('click', hideContextMenu);
            dom.convertBtn.addEventListener('click', () => {
                const link = dom.youtubeLinkInput.value.trim();
                if (link) {
                    showToast("Función de descarga no implementada todavía.");
                } else {
                    showToast("Por favor, pega un enlace de YouTube.");
                }
            });
            dom.nowPlayingToggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleNowPlayingList();
            });
            dom.nowPlayingBackdrop.addEventListener('click', () => {
                toggleNowPlayingList(false);
            });
        }
        
        function getActiveViewId() { return document.querySelector('.view.active')?.id; }
        function updateMiniPlayerVisibility() {
            const activeView = getActiveViewId();
            dom.miniPlayerBar.classList.toggle('visible', activeView !== 'player-view' && !!state.currentSongId);
        }
        function switchView(viewId) {
            dom.views.forEach(view => view.classList.toggle('active', view.id === viewId));
            dom.tabs.forEach(tab => tab.classList.toggle('active', tab.dataset.view === viewId));
            updateMiniPlayerVisibility();
        }
        
        async function handleFileSelect(event) {
            const files = Array.from(event.target.files); 
            if (files.length === 0) return;
            showModal(`<div class="text-center text-primary">Cargando ${files.length} canci&oacute;n(es)...</div>`);
            try {
                const wasEmpty = !state.currentSongId && state.library.length === 0;
                const newSongs = await Promise.all(files.map(processFile)); 
                newSongs.forEach(song => {
                    if (!state.library.some(s => s.id === song.id)) {
                        state.library.push(song);
                        saveSongToDB(song);
                    }
                });
                renderLibrary(); 
                if (wasEmpty && newSongs.length > 0) {
                    playSongFromContext(newSongs[0].id, 'library');
                }
            } catch (error) {
                console.error("Error procesando archivos:", error);
                showToast("Error al cargar canciones");
            } finally {
                closeModal();
            }
        }
        
        async function processFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = arrayBufferToBase64(e.target.result); 
                    const blob = base64ToBlob(data, file.type);
                    const songUrl = URL.createObjectURL(blob);

                    window.jsmediatags.read(file, {
                        onSuccess: (tag) => {
                            const { title, artist, album, picture } = tag.tags;
                            resolve({ 
                                id: self.crypto.randomUUID(), 
                                title: title || file.name.replace(/\.[^/.]+$/, ""), 
                                artist: artist || 'Desconocido', 
                                album: album || 'Desconocido', 
                                art: picture ? `data:${picture.format};base64,${window.btoa(picture.data.reduce((acc, byte) => acc + String.fromCharCode(byte), ''))}` : null, 
                                data, 
                                url: songUrl 
                            });
                        }, onError: (error) => {
                             resolve({ 
                                id: self.crypto.randomUUID(), 
                                title: file.name.replace(/\.[^/.]+$/, ""), 
                                artist: 'Desconocido', 
                                album: 'Desconocido', 
                                art: null, 
                                data, 
                                url: songUrl 
                            });
                        }
                    });
                }; 
                reader.onerror = (error) => reject(error);
                reader.readAsArrayBuffer(file);
            });
        }
        
        function setContext(type, id = null) {
            state.currentContext = { type, id };
            if (type === 'library') state.contextQueue = state.library.map(s => s.id);
            else if (type === 'playlist') {
                const playlist = state.playlists.find(p => p.id === id); if (playlist) state.contextQueue = playlist.songIds;
            } else { state.contextQueue = []; }
            state.contextIndex = state.contextQueue.findIndex(sId => sId === state.currentSongId);
        }
        
        function playSongFromContext(songId, contextType, contextId = null) {
            if (isCrossfading) return;
            if (state.currentContext.type !== contextType || state.currentContext.id !== contextId) { setContext(contextType, contextId); }
            
            const song = getSongById(songId);
            if(song) {
                const currentSong = getSongById(state.currentSongId);
                if (currentSong && currentSong.url && currentSong.url.startsWith('blob:')) {
                    URL.revokeObjectURL(currentSong.url);
                }

                state.contextIndex = state.contextQueue.findIndex(id => id === songId); 
                state.currentSongId = songId;

                audioManager.play(song); 
                updatePlayerUI(song); 
                updateMediaSession(song); 
                updatePlayingStatusInLists(); 
                renderNowPlayingList();
                saveState(); 
            }
        }
        
        function renderPlaylists(playlistId = null) {
            dom.playlistsView.innerHTML = ''; dom.playlistsView.classList.add('pb-40'); 
            if (playlistId) { renderPlaylistDetail(playlistId); } else { renderPlaylistList(); }
        }

        function renderPlaylistList() {
            const header = `<div class="flex justify-between items-center mb-4 sticky top-0 bg-primary pt-2 pb-2 z-10"><h1 class="text-2xl font-bold">Playlists</h1><button id="create-playlist-btn" class="action-btn px-4 py-2 rounded-lg text-sm font-bold">Crear</button></div>`;
            const list = document.createElement('ul'); list.className = 'space-y-2';
            if (state.playlists.length === 0) { list.innerHTML = `<li class="text-center text-secondary p-8">No has creado ninguna playlist.</li>`; }
            else {
                state.playlists.forEach(p => {
                    const li = document.createElement('li'); li.className = 'list-item flex items-center p-3 rounded-lg cursor-pointer space-x-4';
                    li.innerHTML = `<div class="w-12 h-12 rounded-md bg-tertiary flex items-center justify-center"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg></div><div class="flex-grow truncate"><p class="font-semibold text-primary truncate">${p.name}</p><p class="text-sm">${p.songIds.length} canciones</p></div><button data-playlist-id="${p.id}" class="playlist-options-btn p-2 rounded-full hover-bg flex-shrink-0"><svg width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M12 16a2 2 0 0 1 2 2a2 2 0 0 1-2 2a2 2 0 0 1-2-2a2 2 0 0 1 2-2m0-6a2 2 0 0 1 2 2a2 2 0 0 1-2 2a2 2 0 0 1-2-2a2 2 0 0 1 2-2m0-6a2 2 0 0 1 2 2a2 2 0 0 1-2 2a2 2 0 0 1-2-2a2 2 0 0 1 2-2z"/></svg></button>`;
                    li.addEventListener('click', () => renderPlaylists(p.id)); list.appendChild(li);
                });
            }
            dom.playlistsView.innerHTML = header; dom.playlistsView.appendChild(list);
            document.getElementById('create-playlist-btn').addEventListener('click', createPlaylist);
            document.querySelectorAll('.playlist-options-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); const id = e.currentTarget.dataset.playlistId;
                    showContextMenu(e.clientX, e.clientY, [ { label: 'Renombrar', action: () => renamePlaylist(id) }, { label: 'Eliminar', action: () => deletePlaylist(id) } ]);
                });
            });
        }
        
        function renderPlaylistDetail(playlistId) {
            const playlist = state.playlists.find(p => p.id === playlistId); if (!playlist) { renderPlaylists(); return; }
            const header = `<div class="flex items-center mb-4 sticky top-0 bg-primary pt-2 pb-2 z-10"><button id="back-to-playlists-btn" class="p-2 mr-2 rounded-full hover-bg"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button><h1 class="text-2xl font-bold truncate">${playlist.name}</h1></div>`;
            const songList = document.createElement('ul'); songList.className = 'space-y-1'; songList.dataset.context = 'playlist'; songList.dataset.playlistId = playlistId;
            if (playlist.songIds.length === 0) { songList.innerHTML = `<li class="text-center text-secondary p-8">Esta playlist está vacía.</li>`; }
            else { playlist.songIds.forEach(songId => { const song = getSongById(songId); if (song) songList.appendChild(createSongListItem(song)); }); }
            dom.playlistsView.innerHTML = header; dom.playlistsView.appendChild(songList);
            document.getElementById('back-to-playlists-btn').addEventListener('click', () => renderPlaylists());
            updatePlayingStatusInLists();
        }
        
        function toggleNowPlayingList(forceState) {
            const isVisible = dom.nowPlayingContainer.classList.contains('visible');
            const show = forceState !== undefined ? forceState : !isVisible;
            dom.nowPlayingContainer.classList.toggle('visible', show);
            dom.nowPlayingBackdrop.classList.toggle('hidden', !show);
        }

        function renderNowPlayingList() {
            dom.nowPlayingList.innerHTML = '';
            if (!state.currentSongId) return;

            const upcomingSongs = [];
            
            state.queue.forEach(songId => {
                const song = getSongById(songId);
                if (song) upcomingSongs.push(song);
            });
            
            if (state.contextIndex !== -1 && state.contextQueue.length > 0) {
                for (let i = state.contextIndex + 1; i < state.contextQueue.length; i++) {
                    const song = getSongById(state.contextQueue[i]);
                    if (song) upcomingSongs.push(song);
                }
                if (state.repeatMode === 'all') {
                    for (let i = 0; i < state.contextIndex; i++) {
                        const song = getSongById(state.contextQueue[i]);
                        if (song) upcomingSongs.push(song);
                    }
                }
            }

            if(upcomingSongs.length === 0) {
                 dom.nowPlayingList.innerHTML = `<li class="text-center text-secondary p-4 text-sm">Fin de la lista.</li>`;
                 return;
            }

            upcomingSongs.slice(0, 10).forEach((song, index) => {
                const item = dom.songItemTemplate.content.cloneNode(true).querySelector('.list-item');
                item.querySelector('.options-btn').remove();
                item.querySelector('img').className = 'w-10 h-10 rounded-md object-cover flex-shrink-0 bg-tertiary';
                item.querySelector('[data-title]').textContent = song.title; 
                item.querySelector('[data-artist]').textContent = song.artist;
                item.dataset.songId = song.id;
                
                item.addEventListener('click', () => {
                    const clickedSongIndexInUpcoming = upcomingSongs.findIndex(s => s.id === song.id);
                    const newQueue = upcomingSongs.slice(clickedSongIndexInUpcoming).map(s => s.id);
                    
                    state.queue = [];
                    setContext('library'); 
                    
                    const songToPlayId = newQueue.shift();
                    state.queue = newQueue;
                    
                    playSongFromContext(songToPlayId, 'library');
                    toggleNowPlayingList(false);
                });

                dom.nowPlayingList.appendChild(item);
            });
        }
        
        function createPlaylist() { showPromptModal("Nueva Playlist", "Nombre de la playlist", (name) => { if (name && name.trim()) { state.playlists.push({ id: self.crypto.randomUUID(), name: name.trim(), songIds: [] }); saveState(); renderPlaylists(); showToast(`Playlist "${name.trim()}" creada`); } }); }
        function renamePlaylist(playlistId) { const playlist = state.playlists.find(p => p.id === playlistId); if (!playlist) return; showPromptModal("Renombrar Playlist", "Nuevo nombre", (newName) => { if (newName && newName.trim()) { playlist.name = newName.trim(); saveState(); renderPlaylists(); showToast("Playlist renombrada"); } }, playlist.name); }
        function deletePlaylist(playlistId) { const playlist = state.playlists.find(p => p.id === playlistId); if (!playlist) return; showConfirmModal(`¿Eliminar "${playlist.name}"?`, "Esta acción no se puede deshacer.", () => { state.playlists = state.playlists.filter(p => p.id !== playlistId); saveState(); renderPlaylists(); showToast(`Playlist eliminada`); }); }
        function addSongToPlaylist(songId, playlistId) { const playlist = state.playlists.find(p => p.id === playlistId); if (playlist && !playlist.songIds.includes(songId)) { playlist.songIds.push(songId); saveState(); showToast("Canción añadida a la playlist"); } }
        
        function showModal(content) { dom.modalContainer.innerHTML = `<div class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-70 opacity-0 transition-opacity"><div class="modal-content w-full max-w-sm rounded-xl shadow-2xl p-6 space-y-4">${content}</div></div>`; dom.modalContainer.classList.remove('hidden'); const backdrop = dom.modalContainer.querySelector('.modal-backdrop'); setTimeout(() => backdrop.classList.remove('opacity-0'), 10); return backdrop; }
        function closeModal() { const backdrop = dom.modalContainer.querySelector('.modal-backdrop'); if (backdrop) { backdrop.classList.add('opacity-0'); setTimeout(() => { dom.modalContainer.classList.add('hidden'); dom.modalContainer.innerHTML = ''; }, 300); } }
        
        function openAddToPlaylistModal(songId) { let playlistItems = state.playlists.length > 0 ? state.playlists.map(p => `<li class="list-item p-3 rounded-lg cursor-pointer" data-id="${p.id}">${p.name}</li>`).join('') : `<li class="text-center text-secondary p-4">No hay playlists.</li>`; const modalContent = `<h2 class="text-xl font-bold text-primary">Añadir a...</h2><ul class="max-h-60 overflow-y-auto space-y-1">${playlistItems}</ul><button id="close-modal-btn" class="mt-4 w-full bg-tertiary text-primary py-2 rounded-lg hover-bg">Cerrar</button>`; const modal = showModal(modalContent); modal.querySelectorAll('.list-item').forEach(item => { item.addEventListener('click', () => { addSongToPlaylist(songId, item.dataset.id); closeModal(); }); }); modal.querySelector('#close-modal-btn').addEventListener('click', closeModal); }
        
        function openEditSongModal(songId) {
            const song = getSongById(songId);
            if (!song) return;

            const modalContent = `
                <h2 class="text-xl font-bold text-primary">Editar Canción</h2>
                <div class="space-y-4">
                    <div class="flex items-center space-x-4">
                        <img id="edit-art-preview" src="${song.art || 'https://placehold.co/96x96/24283b/c0caf5'}" class="w-24 h-24 rounded-lg object-cover bg-tertiary flex-shrink-0">
                        <div class="flex-grow">
                            <label for="edit-art-file" class="action-btn cursor-pointer inline-block text-center w-full px-3 py-2 rounded-lg text-sm">Cambiar Portada</label>
                            <input id="edit-art-file" type="file" accept="image/*" class="hidden">
                            <p class="text-xs text-center mt-2">Sube una nueva imagen para la carátula.</p>
                        </div>
                    </div>
                    <div>
                        <label for="edit-title" class="text-sm block mb-1">Título</label>
                        <input id="edit-title" type="text" value="${song.title}" class="form-input w-full p-2 rounded focus:outline-none focus:ring-2 focus:ring-accent-primary">
                    </div>
                    <div>
                        <label for="edit-artist" class="text-sm block mb-1">Artista</label>
                        <input id="edit-artist" type="text" value="${song.artist}" class="form-input w-full p-2 rounded focus:outline-none focus:ring-2 focus:ring-accent-primary">
                    </div>
                    <div>
                        <label for="edit-album" class="text-sm block mb-1">Álbum</label>
                        <input id="edit-album" type="text" value="${song.album}" class="form-input w-full p-2 rounded focus:outline-none focus:ring-2 focus:ring-accent-primary">
                    </div>
                </div>
                <div class="flex justify-end space-x-2 mt-6">
                    <button id="edit-cancel" class="bg-tertiary px-4 py-2 rounded-lg">Cancelar</button>
                    <button id="edit-save" class="action-btn px-4 py-2 rounded-lg">Guardar</button>
                </div>`;
            
            const modal = showModal(modalContent);
            
            const artPreview = modal.querySelector('#edit-art-preview');
            const artFileInput = modal.querySelector('#edit-art-file');
            let newArtData = null;

            artFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        newArtData = event.target.result; 
                        artPreview.src = newArtData;
                    };
                    reader.readAsDataURL(file);
                }
            });

            modal.querySelector('#edit-save').addEventListener('click', () => {
                song.title = modal.querySelector('#edit-title').value.trim() || 'Título Desconocido';
                song.artist = modal.querySelector('#edit-artist').value.trim() || 'Artista Desconocido';
                song.album = modal.querySelector('#edit-album').value.trim() || 'Álbum Desconocido';
                
                if (newArtData) {
                    song.art = newArtData;
                }

                saveSongToDB(song); 
                renderLibrary();
                if (song.id === state.currentSongId) {
                    updatePlayerUI(song);
                    updateMediaSession(song);
                }
                updatePlayingStatusInLists();
                closeModal();
                showToast("Metadatos actualizados");
            });
            modal.querySelector('#edit-cancel').addEventListener('click', closeModal);
        }

        function showPromptModal(title, label, callback, defaultValue = '') { const modalContent = `<h2 class="text-xl font-bold text-primary">${title}</h2><label for="prompt-input" class="text-sm">${label}</label><input id="prompt-input" type="text" value="${defaultValue}" class="form-input w-full p-2 rounded focus:outline-none focus:ring-2 focus:ring-accent-primary"><div class="flex justify-end space-x-2 mt-4"><button id="prompt-cancel" class="bg-tertiary px-4 py-2 rounded-lg">Cancelar</button><button id="prompt-ok" class="action-btn px-4 py-2 rounded-lg">Aceptar</button></div>`; const modal = showModal(modalContent); const input = modal.querySelector('#prompt-input'); input.focus(); input.select(); const handleOk = () => { const value = input.value; closeModal(); setTimeout(() => callback(value), 100); }; modal.querySelector('#prompt-ok').addEventListener('click', handleOk); input.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleOk(); }); modal.querySelector('#prompt-cancel').addEventListener('click', closeModal); }
        function showConfirmModal(title, message, onConfirm) { const modalContent = `<h2 class="text-xl font-bold text-primary">${title}</h2><p class="text-sm">${message}</p><div class="flex justify-end space-x-2 mt-4"><button id="confirm-cancel" class="bg-tertiary px-4 py-2 rounded-lg">Cancelar</button><button id="confirm-ok" class="bg-red-600 text-white px-4 py-2 rounded-lg">Confirmar</button></div>`; const modal = showModal(modalContent); modal.querySelector('#confirm-ok').addEventListener('click', () => { onConfirm(); closeModal(); }); modal.querySelector('#confirm-cancel').addEventListener('click', closeModal); }
        function showToast(message) { const toast = document.createElement('div'); toast.className = 'toast-notification'; toast.textContent = message; document.body.appendChild(toast); setTimeout(() => { toast.style.opacity = '1'; toast.style.transform = 'translate(-50%, 0)'; }, 10); setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translate(-50%, 20px)'; setTimeout(() => toast.remove(), 300); }, 2500); }
        function showContextMenu(x, y, items) { dom.contextMenu.innerHTML = ''; items.forEach(item => { const li = document.createElement('li'); li.textContent = item.label; li.className = 'px-4 py-2 hover-bg rounded cursor-pointer'; li.addEventListener('click', () => { item.action(); hideContextMenu(); }); dom.contextMenu.appendChild(li); }); const menuWidth = dom.contextMenu.offsetWidth; const menuHeight = dom.contextMenu.offsetHeight; const correctedX = (x + menuWidth > window.innerWidth) ? window.innerWidth - menuWidth - 10 : x; const correctedY = (y + menuHeight > window.innerHeight) ? window.innerHeight - menuHeight - 10 : y; dom.contextMenu.style.left = `${correctedX}px`; dom.contextMenu.style.top = `${correctedY}px`; dom.contextMenu.classList.remove('hidden'); dom.contextMenuBackdrop.classList.remove('hidden'); }
        function hideContextMenu() { dom.contextMenu.classList.add('hidden'); dom.contextMenuBackdrop.classList.add('hidden'); }
        function openSettingsModal() { const modalContent = `<div class="flex justify-between items-center mb-2"><h2 class="text-2xl font-bold">Configuración</h2><button id="close-settings-btn" class="p-2 rounded-full hover-bg text-2xl leading-none">&times;</button></div><div class="space-y-2"><div class="flex items-center justify-between py-2"><label for="crossfade-toggle" class="text-sm">Crossfade Automático</label><div class="flex items-center space-x-3"><span id="crossfade-duration-label" class="text-xs w-12 text-center"></span><input type="range" id="crossfade-duration-slider" min="1" max="10" class="w-24"><input type="checkbox" id="crossfade-toggle" class="form-checkbox h-5 w-5 rounded bg-slate-700 border-slate-600 text-accent-primary focus:ring-accent-primary"></div></div> <div class="py-2"> <label class="text-sm">Tema</label> <div id="theme-selector" class="flex items-center space-x-4 py-2"><button data-theme="default" class="theme-btn w-8 h-8 rounded-full bg-[#1a1b26] border-2 border-slate-500"></button><button data-theme="sunset" class="theme-btn w-8 h-8 rounded-full bg-[#2d1d2b] border-2 border-slate-500"></button><button data-theme="ocean" class="theme-btn w-8 h-8 rounded-full bg-[#1f2c27] border-2 border-slate-500"></button></div></div></div>`; const modal = showModal(modalContent); modal.querySelector('#close-settings-btn').addEventListener('click', closeModal); const crossfadeToggle = modal.querySelector('#crossfade-toggle'); const crossfadeSlider = modal.querySelector('#crossfade-duration-slider'); const crossfadeLabel = modal.querySelector('#crossfade-duration-label'); crossfadeToggle.checked = state.settings.crossfadeEnabled; crossfadeSlider.value = state.settings.crossfadeDuration; crossfadeLabel.textContent = `${state.settings.crossfadeDuration}s`; crossfadeToggle.addEventListener('change', (e) => { state.settings.crossfadeEnabled = e.target.checked; saveState(); }); crossfadeSlider.addEventListener('input', (e) => { state.settings.crossfadeDuration = parseInt(e.target.value); crossfadeLabel.textContent = `${state.settings.crossfadeDuration}s`; }); crossfadeSlider.addEventListener('change', saveState); modal.querySelectorAll('.theme-btn').forEach(btn => btn.addEventListener('click', (e) => { state.settings.theme = e.currentTarget.dataset.theme; applyTheme(); saveState(); })); }
        function applyTheme(){ dom.body.className = `theme-${state.settings.theme || 'default'}`; }
        function formatTime(s) { const m=Math.floor(s/60),c=Math.floor(s%60); return isNaN(m)?'0:00':`${m}:${c<10?'0':''}${c}`; }
        function arrayBufferToBase64(b) { let s='';new Uint8Array(b).forEach(v=>s+=String.fromCharCode(v));return window.btoa(s); }
        function updateMediaSession(s) { if(!('mediaSession'in navigator))return;navigator.mediaSession.metadata=new MediaMetadata({title:s.title,artist:s.artist,album:s.album,artwork:[{src:s.art||''}]});navigator.mediaSession.setActionHandler('play',togglePlayPause);navigator.mediaSession.setActionHandler('pause',togglePlayPause);navigator.mediaSession.setActionHandler('nexttrack', () => playNextSong(false));navigator.mediaSession.setActionHandler('previoustrack',playPrevSong);navigator.mediaSession.setActionHandler('seekto', (details) => { audioManager.seek(details.seekTime); });}
        function toggleShuffle() { state.isShuffle = !state.isShuffle; updateControlButtonsUI(); saveState(); renderNowPlayingList(); }
        function cycleRepeatMode() { const modes = ['none', 'all', 'one']; state.repeatMode = modes[(modes.indexOf(state.repeatMode) + 1) % modes.length]; updateControlButtonsUI(); saveState(); renderNowPlayingList(); }
        
        function updateControlButtonsUI() {
            dom.shuffleBtn.classList.toggle('active', state.isShuffle);
            dom.repeatBtn.classList.toggle('active', state.repeatMode !== 'none');
            
            const repeatIconSVG = {
                none: `<polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path>`,
                all: `<polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path>`,
                one: `<path d="M17 2l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 22l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/><path d="M14.5 10.5c-1-2-3-2.5-4.5-1-2.5 2.5 1.5 6.5 4.5 5.5.5-1.5-2-1-1.5-3 .5-.5 2-1 1.5-1.5z"/>`
            };
            dom.repeatBtn.querySelector('svg').innerHTML = repeatIconSVG[state.repeatMode] || repeatIconSVG['none'];
        }
        
        function setupSVGs(){
            const icons = {
                'settings-btn': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>`,
                'play-pause-btn': `<svg data-play-icon width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg><svg data-pause-icon class="hidden" width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>`,
                'mini-play-pause-btn': `<svg data-play-icon width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg><svg data-pause-icon class="hidden" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>`,
                'prev-btn': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></svg>',
                'next-btn': '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg>',
                'shuffle-btn': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg>',
                'repeat-btn': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"></svg>',
                'now-playing-toggle-btn': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 6h13"/><path d="M8 12h13"/><path d="M8 18h13"/><path d="M3 6h.01"/><path d="M3 12h.01"/><path d="M3 18h.01"/></svg>`
            };
            for (const [id, svg] of Object.entries(icons)) { if(document.getElementById(id)) document.getElementById(id).innerHTML = svg; }
            const tabsData = [ 
                { id: "player-view", svg: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg><span>Reproductor</span>` }, 
                { id: "library-view", svg: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15V6M18.5 18a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5ZM12 12H3M16 6H3M12 18H3"/></svg><span>Biblioteca</span>` }, 
                { id: "playlists-view", svg: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Playlists</span>` }, 
                { id: "download-view", svg: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg><span>Descargar</span>` } 
            ];
            dom.tabs.forEach((tab, index) => { tab.innerHTML = tabsData[index].svg; });
            updateControlButtonsUI();
        }
        
        initDB(initApp);
    });
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>
</html>